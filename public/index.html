<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Reset ‡πÅ‡∏•‡∏∞ base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html, body {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    /* Navigation */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .navbar h1 {
      font-size: 1.5rem;
      margin: 0;
    }
    
    .navbar-links {
      float: right;
      margin-top: 5px;
    }
    
    .navbar-links a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      padding: 8px 15px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    
    .navbar-links a:hover {
      background-color: rgba(255,255,255,0.2);
    }
    
    /* Map container */
    #map {
      height: 100%;
      width: 100%;
      margin-top: 70px; /* ‡πÉ‡∏´‡πâ space ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö navbar */
    }
    
    /* Loading indicator */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 16px;
    }
    
    /* Info panel */
    .info-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 999;
      max-width: 300px;
      font-size: 14px;
    }
    
    .info-panel h3 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .info-panel p {
      margin: 5px 0;
      color: #666;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-number {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .stat-label {
      font-size: 12px;
      color: #999;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div class="navbar">
    <h1>üó∫Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ - ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</h1>
    <div class="navbar-links">
      <a href="/admin" target="_blank">üîß Admin Panel</a>
      <a href="/api/info" target="_blank">üìã API Info</a>
      <a href="#" onclick="refreshMap()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</a>
    </div>
  </div>

  <!-- Map Container -->
  <div id="map"></div>
  
  <!-- Loading Indicator -->
  <div id="loading" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  
  <!-- Info Panel -->
  <div class="info-panel">
    <h3>üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
    <p><strong>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô:</strong> 1.0.0</p>
    <p><strong>‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå:</strong> localhost:3001</p>
    <p><strong>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong> Prisma + PostgreSQL</p>
    
    <div class="stats">
      <div class="stat-item">
        <div id="totalMarkers" class="stat-number">0</div>
        <div class="stat-label">‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
      <div class="stat-item">
        <div id="activeBuildings" class="stat-number">0</div>
        <div class="stat-label">‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
      </div>
    </div>
  </div>

  <script>
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    const map = L.map('map').setView([13.736717, 100.523186], 6)

    // layer ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map)

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    let mapData = []
    let markers = []

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡πà‡∏≠‡∏ô loading
    function hideLoading() {
      const loading = document.getElementById('loading')
      if (loading) {
        loading.style.display = 'none'
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á error
    function showError(message) {
      const loading = document.getElementById('loading')
      if (loading) {
        loading.innerHTML = `‚ùå ${message}`
        loading.style.background = 'rgba(255,0,0,0.8)'
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    function updateStats() {
      const totalMarkers = markers.length
      const activeBuildings = mapData.filter(item => item.buildingControl?.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥').length
      
      document.getElementById('totalMarkers').textContent = totalMarkers
      document.getElementById('activeBuildings').textContent = activeBuildings
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á markers
    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker))
      markers = []
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
    function refreshMap() {
      clearMarkers()
      loadData()
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
    async function loadData() {
      try {
        // ‡πÅ‡∏™‡∏î‡∏á loading
        const loading = document.getElementById('loading')
        if (loading) {
          loading.style.display = 'block'
          loading.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...'
          loading.style.background = 'rgba(0,0,0,0.8)'
        }

        // ‡πÉ‡∏ä‡πâ port 3001 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
        const res = await fetch('http://localhost:3001/api/map')
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`)
        }
        
        const json = await res.json()
        
        if (!json.success) {
          throw new Error(json.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•')
        }
        
        mapData = json.data || []

        if (mapData.length === 0) {
          hideLoading()
          showError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö')
          updateStats()
          return
        }

        const markerPositions = []

        mapData.forEach(item => {
          const { id, latitude, longitude, name_local, buildingControl } = item
          if (!latitude || !longitude) return

          // ‡∏™‡∏£‡πâ‡∏≤‡∏á marker
          const marker = L.marker([latitude, longitude]).addTo(map)
          markers.push(marker)
          
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á popup content
          const popupContent = `
            <div style="min-width: 250px;">
              <h4 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 5px;">
                ${name_local || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'}
              </h4>
              <p><strong>üÜî ID:</strong> ${id}</p>
              <p><strong>üè¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${buildingControl?.building_type || "-"}</p>
              <p><strong>üéØ ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</strong> ${buildingControl?.use_purpose || "-"}</p>
              <p><strong>üìã ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:</strong> ${buildingControl?.license_number || "-"}</p>
              <p><strong>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> 
                <span style="color: ${buildingControl?.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? 'green' : 'orange'}; font-weight: bold;">
                  ${buildingControl?.status || "-"}
                </span>
              </p>
            </div>
          `
          
          marker.bindPopup(popupContent)

          markerPositions.push([latitude, longitude])
        })

        // ‡∏õ‡∏£‡∏±‡∏ö zoom ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å marker
        if (markerPositions.length > 0) {
          map.fitBounds(markerPositions)
        }

        hideLoading()
        updateStats()
        
        console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${mapData.length} ‡∏à‡∏∏‡∏î`)
        
      } catch (err) {
        console.error("‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", err)
        showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${err.message}`)
        updateStats()
      }
    }

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    loadData()
  </script>
</body>
</html>
